@Library('piper-lib-os') _


pipeline {
    agent any
    stages {
        stage("prepare") {
            steps {
                deleteDir()
                checkout scm
                setupCommonPipelineEnvironment script: this
                script {
					env.BRANCH_NAME = "${env.GIT_BRANCH}"			                    
				    }
                 }
              } 
         stage('build') {
         	when{
         	    expression {
         	        env.GIT_BRANCH != "origin/CF_develop"
         	    }
         	}
            steps {
            	echo "${env.GIT_BRANCH}"          
               mtaBuild script: this, mtaBuildTool: 'cloudMbt'
            }
        }
    
        stage('Nexus deploy'){
        	when{
         	    expression {
         	        env.GIT_BRANCH != "origin/CF_develop"
         	    	}
         	  }  	
        	steps{           	
           	 // BUILD_NUMBER && JOB_NAME im statement           	
        	    nexusPublisher nexusInstanceId: 'localnexus', nexusRepositoryId: 'maven-releases', packages: [[$class: 'MavenPackage', mavenAssetList: [[classifier: '', extension: '', filePath: '/var/jenkins_home/workspace/'+ env.JOB_NAME +'/ci_test_project.mtar']], mavenCoordinate: [artifactId: 'jenkins-mtar', groupId: 'org.jenkins-CF.main', packaging: '.mtar', version: '1.' + env.BUILD_NUMBER]]]
        		}
		}	
		stage('Attach'){
		     steps{
             	script{
               			env.TransportID = commonPipelineEnvironment.getTransportRequestId()
                }
              
                	transportRequestUploadFile script: this, transportRequestId: 'env.TransportID'        	
                	//cloudFoundryDeploy script:this, deployTool:'mtaDeployPlugin', verbose: true
				}
        	}
    	}
   } 	